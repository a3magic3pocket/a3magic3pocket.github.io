<!DOCTYPE html><html lang="ko-KR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="spring security 6에서 oauth2.0 구현하기(google)" /><meta property="og:locale" content="ko_KR" /><meta name="description" content="개요 spring security 6을 이용하여 oauth2.0 인증을 구현해본다. 예시에서는 oauth 2.0 인증 프로바이더로 google을 사용한다." /><meta property="og:description" content="개요 spring security 6을 이용하여 oauth2.0 인증을 구현해본다. 예시에서는 oauth 2.0 인증 프로바이더로 google을 사용한다." /><link rel="canonical" href="https://a3magic3pocket.github.io/posts/spring-security-6-oauth2-google/" /><meta property="og:url" content="https://a3magic3pocket.github.io/posts/spring-security-6-oauth2-google/" /><meta property="og:site_name" content="의사줌치" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-03-26T20:37:39+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="spring security 6에서 oauth2.0 구현하기(google)" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"개요 spring security 6을 이용하여 oauth2.0 인증을 구현해본다. 예시에서는 oauth 2.0 인증 프로바이더로 google을 사용한다.","url":"https://a3magic3pocket.github.io/posts/spring-security-6-oauth2-google/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://a3magic3pocket.github.io/posts/spring-security-6-oauth2-google/"},"headline":"spring security 6에서 oauth2.0 구현하기(google)","dateModified":"2024-03-27T20:16:37+09:00","datePublished":"2024-03-26T20:37:39+09:00","@context":"https://schema.org"}</script><title>spring security 6에서 oauth2.0 구현하기(google) | 의사줌치</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="의사줌치"><meta name="application-name" content="의사줌치"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-5NQ41XXW83"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-5NQ41XXW83'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/sample/avatar-crop.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">의사줌치</a></div><div class="site-subtitle font-italic">부정확한 정보를 <br /> 담고 있을 수 있습니다.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/a3magic3pocket" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['a3magic3pocket','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>spring security 6에서 oauth2.0 구현하기(google)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>spring security 6에서 oauth2.0 구현하기(google)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> 의사줌치 </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Mar 26, 2024, 8:37 PM +0900" prep="on" > Mar 26, 2024 <i class="unloaded">2024-03-26T20:37:39+09:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Mar 27, 2024, 8:16 PM +0900" prefix="Updated " > Mar 27, 2024 <i class="unloaded">2024-03-27T20:16:37+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3276 words">18 min</span></div></div><div class="post-content"><h2 id="개요">개요</h2><ul><li>spring security 6을 이용하여 oauth2.0 인증을 구현해본다.<li>예시에서는 oauth 2.0 인증 프로바이더로 google을 사용한다.</ul><h2 id="oauth-20-이란">Oauth 2.0 이란</h2><ul><li>표준화된 인증 방식을 의미한다.<li>한 곳에서 Ouath 인증을 하면 이 인증을 공유하는 애플리케이션끼리<br /> 별도의 인증 없이 인증할 수 있다[<a href="https://ko.wikipedia.org/wiki/OAuth" target="_blank">참고1</a>].</ul><h2 id="일반적인-구글-oauth-20-구현-과정">일반적인 구글 Oauth 2.0 구현 과정</h2><ul><li>구글 콘솔에서 oauth 2.0 사용자를 등록한다.<br /> 이떄 구글 로그인 성공 시 access_token을 받을 <br /> redirect_uri를 입력해야 한다.<li>redirect_uri는 로그인 처리를 할 백엔드 uri를 입력하면 된다.<li>등록에 성공하면 구글 oauth 2.0의 client-id와 client-secret을 얻을 수 있다.<li>[구글] 사용자가 버튼을 클릭하면 구글 로그인 페이지로 이동한다.<br /> 로그인에 성공하면 미리 지정한 redirect_uri로 이동한다.<li>[내 앱 프론트엔드] 구글 로그인 url으로 리다이렉트 [<a href="https://developers.google.com/identity/protocols/oauth2/javascript-implicit-flow?hl=ko" target="_blank">참고2</a>].<ul><li>url<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>curl <span class="nt">-XGET</span> <span class="s2">"https://accounts.google.com/o/oauth2/v2/auth?  
 scope=https://www.googleapis.com/auth/userinfo.profile&amp;  
 include_granted_scopes=true&amp;  
 response_type=code&amp;  
 state=state_parameter_passthrough_value&amp;  
 redirect_uri=https://myapp-backend.com/google/callback&amp;  
 client_id=my-client_id"</span>  
</pre></table></code></div></div><ul><li>scope<ul><li>구글 로그인 성공 시 접근 가능한 정보 범위이다.<br /> 최초 구글 콘솔에서 등록한 접근 가능 정보만 허용된다.<li><a href="https://developers.google.com/identity/protocols/oauth2/scopes?hl=ko#oauth2" target="_blank">scope list</a></ul><li>response_type<ul><li>request token이 담길 파라미터 이름<li>request token을 이용하여 access_token을 발행할 수 있다.</ul><li>redirect_uri<ul><li>구글 로그인 성공 시 리다이렉트 할 uri이다.<li>최초 구글 콘솔에서 등록한 uri로만 허용된다.</ul><li>client_id<ul><li>구글 콘솔에서 발급 받은 client_id이다.</ul></ul></ul><li>[내 앱 백엔드] request_token 수신<ul><li>구글 로그인에 성공하여 redirect_uri 응답을 받으면<br /> request_token이 RequestParam의 code에 담겨 오게 된다.<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>// 응답 예시  
https://myapp-backend.com/google/callback?code<span class="o">=</span>4/P7q7W91a-oMsCeLvIaQm6bTrgtp7  
</pre></table></code></div></div></ul><li>[내 앱 백엔드] access_token 발급<ul><li>request_token과 client-id, client-secret을 이용하여<br /> access_token을 발급한다[<a href="https://notspoon.tistory.com/47" target="_blank">참고3</a>].<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>curl <span class="nt">-XPOST</span> <span class="s2">"https://oauth2.googleapis.com/token?code=my-code&amp;client_id=my-client-id&amp;client_secret=my-client-secret&amp;redirect_uri=https://myapp-backend.com/google/callback&amp;grant_type=authorization_code"</span>  <span class="se">\ </span> 
<span class="nt">--header</span> <span class="s2">"Content-Type: application/x-www-form-urlencoded"</span>  
</pre></table></code></div></div></ul><li>[내 앱 백엔드] acces_token 수신<ul><li>요청에 성공하였다면 아래 정보가 body에 담겨 응답을 받는다.<div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">  
    </span><span class="nl">"access_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_access_token"</span><span class="p">,</span><span class="w">  
    </span><span class="nl">"expires_tn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_expires_tn"</span><span class="p">,</span><span class="w">  
    </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_scope"</span><span class="p">,</span><span class="w">  
    </span><span class="nl">"token_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_token_type"</span><span class="p">,</span><span class="w">  
    </span><span class="nl">"id_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_id_token"</span><span class="w">  
</span><span class="p">}</span><span class="w">  
</span></pre></table></code></div></div></ul><li>[내 앱 백엔드] 유저 정보 조회<ul><li>access_token을 이용하여 유저 정보를 요청한다.<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>curl <span class="nt">-XGET</span> <span class="s2">"https://www.googleapis.com/oauth2/v1/userinfo"</span> <span class="se">\ </span> 
<span class="nt">--header</span> <span class="s2">"Authorization: Bearer my-access-token"</span>  
</pre></table></code></div></div></ul><li>[내 앱 백엔드] 유저 정보 수신<ul><li>요청에 성공하였다면 아래 정보가 body에 담겨 응답을 받는다.<div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="w"> </span><span class="p">{</span><span class="w">  
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-id"</span><span class="p">,</span><span class="w">  
    </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-email"</span><span class="p">,</span><span class="w">  
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-name"</span><span class="p">,</span><span class="w">  
    </span><span class="nl">"locale"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-locale"</span><span class="w">  
</span><span class="p">}</span><span class="w">  
</span></pre></table></code></div></div><li>받은 응답으로 내 앱 유저 등록 및 로그인 처리를 진행하면 된다.</ul></ul><h2 id="spring-security-6에서의-구글-oauth20">spring security 6에서의 구글 Oauth2.0</h2><ul><li>개요<ul><li>spring security 6을 사용한다면<br /> 위의 과정을 직접 구현할 필요가 없다.<li>구글 콘솔에서 oauth 2.0 사용자를 등록 후<br /> 관련 정보를 spring boot에 설정값으로 넣어주면<br /> 알아서 처리된다.</ul><li>환경<ul><li>java 21<li>spring boot 3.2.3</ul><li>설치<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>implementation <span class="s1">'org.springframework.boot:spring-boot-starter-security'</span>  
implementation <span class="s1">'org.thymeleaf.extras:thymeleaf-extras-springsecurity6'</span>  
implementation <span class="s1">'org.springframework.boot:spring-boot-starter-webflux'</span>  
implementation <span class="s1">'org.springframework.boot:spring-boot-starter-oauth2-client'</span>  
</pre></table></code></div></div><li>application.properties<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># Spring Security  </span>
spring.security.oauth2.client.registration.google.client-id<span class="o">=</span>my-client  
spring.security.oauth2.client.registration.google.client-secret<span class="o">=</span>my-client-secret  
spring.security.oauth2.client.registration.google.authorization-grant-type<span class="o">=</span>authorization_code  
spring.security.oauth2.client.registration.google.scope<span class="o">=</span>profile, email  
</pre></table></code></div></div><li>[내 앱 프론트엔드] 구글 로그인 url으로 리다이렉트<ul><li>기본 구글 로그인 url<ul><li>https://myapp-backend.com/oauth2/authorization/google</ul><li>구글 로그인 url 변경<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c"># application.properties에 추가  </span>
spring.security.oauth2.client.provider.google.authorization-uri<span class="o">=</span>https://myapp-backend.com/oauth2/authorization/google-custom  
</pre></table></code></div></div><li>예시<div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://myapp-backend.com/oauth2/authorization/google"</span><span class="nt">&gt;</span>  
  구글로그인  
<span class="nt">&lt;/a&gt;</span>  
</pre></table></code></div></div></ul><li>[구글] 구글 로그인 화면으로 리다이렉트<br /> 로그인에 성공하면 지정된 redirect_uri로 이동<ul><li>기본 redirect_uri<ul><li>https://myapp-backend.com/login/oauth2/code/google</ul><li>redirect_uri 변경<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>spring.security.oauth2.client.registration.google.redirect-uri<span class="o">=</span>https://myapp-backend.com/login/oauth2/code/custom-google  
</pre></table></code></div></div><li>주의사항<ul><li>구글 콘솔에서 OAuth 2.0 사용자 등록 시에<br /> 위의 redirect_uri도 등록해야 구글 로그인이 가능하다.</ul></ul><li>이후 과정<ul><li>나머지는 알아서 처리해준다.<br /> 로그인에 성공했다면 바로 세션 쿠키를 얻게 된다.</ul></ul><h2 id="spring-security-6-설정">spring security 6 설정</h2><ul><li>개요<ul><li>인증이 필요한 url과 인증이 필요한 url을 설정한다.<li>허가되지 않은 접근 시 401 에러를 리턴한다.<li>로그인에 성공하면 특정 url로 리다이렉트 한다.<br /> [<a href="https://growth-coder.tistory.com/135" target="_blank">참고4</a>][<a href="https://spring.io/guides/tutorials/spring-boot-oauth2#_social_login_simple" target="_blank">참고5</a>][<a href="https://docs.spring.io/spring-security/reference/servlet/oauth2/login/core.html#oauth2login-sample-boot" target="_blank">참고6</a>][<a href="https://docs.spring.io/spring-security/reference/servlet/oauth2/index.html#oauth2-client" target="_blank">참고7</a>]</ul><li>설정<ul><li>설명<ul><li>SecurityGroup Configuration을 생성하고<br /> 하위에 SecurityFilterChain 빈을 생성한다.</ul><li>코드<ul><li>global/config/SecurityGroup.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>  
<span class="nd">@RequiredArgsConstructor</span>  
<span class="nd">@EnableWebSecurity</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityGroup</span> <span class="o">{</span>  
    <span class="nd">@Bean</span>  
    <span class="nc">SecurityFilterChain</span> <span class="nf">filterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>  
                    
        <span class="c1">// @formatter:off  </span>
        <span class="n">http</span>  
            <span class="o">.</span><span class="na">csrf</span><span class="o">(</span><span class="nl">AbstractHttpConfigurer:</span><span class="o">:</span><span class="n">disable</span><span class="o">)</span>  
            <span class="o">.</span><span class="na">authorizeHttpRequests</span><span class="o">((</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">a</span>  
                            <span class="c1">// 인증이 필요한 페이지  </span>
                            <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="s">"/private"</span><span class="o">).</span><span class="na">authenticated</span><span class="o">()</span>  
                            <span class="c1">// 그 외 나머지 페이지는 인증 없이 접근 가능  </span>
                            <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">()</span>  
            <span class="o">)</span>  
             <span class="c1">// 허가되지 않은 접근 시 401 에러 리턴  </span>
            <span class="o">.</span><span class="na">exceptionHandling</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span>  
                            <span class="o">.</span><span class="na">authenticationEntryPoint</span><span class="o">(</span><span class="k">new</span> <span class="nc">HttpStatusEntryPoint</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">))</span>  
            <span class="o">)</span>  
            <span class="o">.</span><span class="na">oauth2Login</span><span class="o">(</span><span class="n">l</span> <span class="o">-&gt;</span> <span class="n">l</span>  
                     <span class="c1">// 로그인에 성공하면 /success 페이지로 이동  </span>
                    <span class="o">.</span><span class="na">defaultSuccessUrl</span><span class="o">(</span><span class="s">"/success"</span><span class="o">)</span>  
            <span class="o">)</span>  
            <span class="o">;</span>  
        <span class="c1">// @formatter:on  </span>
                    
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>  
    <span class="o">}</span>  
<span class="o">}</span>  
</pre></table></code></div></div><li>oauth/AuthController.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@RestController</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthController</span> <span class="o">{</span>  
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/auth/success"</span><span class="o">)</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">authSucessful</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="s">"hello"</span><span class="o">;</span>  
    <span class="o">}</span>  
<span class="o">}</span>  
</pre></table></code></div></div><li>expt/ExptController.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nd">@RestController</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExptController</span> <span class="o">{</span>  
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/private"</span><span class="o">)</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">private</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="s">"private"</span><span class="o">;</span>  
    <span class="o">}</span>  
                    
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/normal"</span><span class="o">)</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">normal</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="s">"normal"</span><span class="o">;</span>  
    <span class="o">}</span>  
<span class="o">}</span>  
</pre></table></code></div></div></ul></ul></ul><h2 id="인증authentication-처리">인증(Authentication) 처리</h2><ul><li>개요<ul><li>OAuth 2.0 로그인에 성공하면 회원정보를 받게 된다.<ul><li>예시<div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">  
    </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-email"</span><span class="p">,</span><span class="w">  
    </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-openId"</span><span class="p">,</span><span class="w">  
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-name"</span><span class="p">,</span><span class="w">  
    </span><span class="nl">"locale"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-locale"</span><span class="w">  
</span><span class="p">}</span><span class="w">  
</span></pre></table></code></div></div><li>sub<ul><li>sub은 OpenId로 고유값이다.</ul></ul><li>OAuth 2.0 회원정보를 바탕으로<br /> 유저의 DB 등록여부를 판단한다.<li>등록되지 않은 유저인 경우, DB에 회원정보를 기록한다.<li>위 부분은 OAuth2UserService의 loadUser를 <br /> Override하여 구현할 수 있다[<a href="https://codediary21.tistory.com/73" target="_blank">참고8</a>].</ul><li>user/User.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nd">@Document</span><span class="o">(</span><span class="n">collection</span> <span class="o">=</span> <span class="nc">MongodbCollectionName</span><span class="o">.</span><span class="na">USER</span><span class="o">)</span>  
<span class="nd">@Getter</span>  
<span class="nd">@Setter</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>  
    <span class="nd">@Id</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">_id</span><span class="o">;</span>  
            
    <span class="nd">@Indexed</span><span class="o">(</span><span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">openId</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">locale</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">provider</span><span class="o">;</span>  
<span class="o">}</span>  
</pre></table></code></div></div><li>user/UserRepository.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nd">@Repository</span>  
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">MongoRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>  
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">findByEmail</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">);</span>  
<span class="o">}</span>  
</pre></table></code></div></div><li>oauth/OAuth2UserService.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre><td class="rouge-code"><pre><span class="nd">@RequiredArgsConstructor</span>  
<span class="nd">@Service</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2UserService</span> <span class="kd">extends</span> <span class="nc">DefaultOAuth2UserService</span> <span class="o">{</span>  
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>  
            
    <span class="nd">@Override</span>  
    <span class="kd">public</span> <span class="nc">OAuth2User</span> <span class="nf">loadUser</span><span class="o">(</span><span class="nc">OAuth2UserRequest</span> <span class="n">userRequest</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">OAuth2AuthenticationException</span> <span class="o">{</span>  
        <span class="nc">OAuth2User</span> <span class="n">oAuth2User</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">loadUser</span><span class="o">(</span><span class="n">userRequest</span><span class="o">);</span>  
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"oAuth2User = "</span> <span class="o">+</span> <span class="n">oAuth2User</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">());</span>  
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">oAuth2User</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">();</span>  
            
        <span class="c1">// OAuth 2.0 프로바이더 명  </span>
        <span class="nc">String</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">getClientRegistration</span><span class="o">().</span><span class="na">getRegistrationId</span><span class="o">();</span>  
            
        <span class="c1">// 유저 획득  </span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">saveNewUser</span><span class="o">(</span><span class="n">attributes</span><span class="o">,</span> <span class="n">provider</span><span class="o">);</span>  
            
        <span class="c1">// authorities 설정  </span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>  
        <span class="n">authorities</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">OAuth2UserAuthority</span><span class="o">(</span><span class="n">userAttributes</span><span class="o">));</span>  
        <span class="nc">OAuth2AccessToken</span> <span class="n">token</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">getAccessToken</span><span class="o">();</span>  
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">authority</span> <span class="o">:</span> <span class="n">token</span><span class="o">.</span><span class="na">getScopes</span><span class="o">())</span> <span class="o">{</span>  
            <span class="n">authorities</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">"SCOPE_"</span> <span class="o">+</span> <span class="n">authority</span><span class="o">));</span>  
        <span class="o">}</span>  
            
        <span class="c1">// 고유값 키 할당; default = "sub"  </span>
        <span class="nc">String</span> <span class="n">userNameAttributeName</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">getClientRegistration</span><span class="o">().</span><span class="na">getProviderDetails</span><span class="o">().</span><span class="na">getUserInfoEndpoint</span><span class="o">()</span>  
                <span class="o">.</span><span class="na">getUserNameAttributeName</span><span class="o">();</span>  
            
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultOAuth2User</span><span class="o">(</span><span class="n">authorities</span><span class="o">,</span> <span class="n">attributes</span><span class="o">,</span> <span class="n">userNameAttributeName</span><span class="o">);</span>  
    <span class="o">}</span>  
            
    <span class="kd">private</span> <span class="nc">User</span> <span class="nf">saveNewUser</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">,</span> <span class="nc">String</span> <span class="n">provider</span><span class="o">)</span> <span class="o">{</span>  
        <span class="nc">String</span> <span class="n">email</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">);</span>  
        <span class="nc">String</span> <span class="n">openId</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="s">"sub"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>  
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>  
        <span class="nc">String</span> <span class="n">locale</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="s">"locale"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>  
            
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>  
        <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  
            <span class="nc">User</span> <span class="n">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setOpenId</span><span class="o">(</span><span class="n">openId</span><span class="o">);</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setLocale</span><span class="o">(</span><span class="n">locale</span><span class="o">);</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setProvider</span><span class="o">(</span><span class="n">provider</span><span class="o">);</span>  
            <span class="nc">User</span> <span class="n">createdUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">newUser</span><span class="o">);</span>  
            
            <span class="k">return</span> <span class="n">createdUser</span><span class="o">;</span>  
        <span class="o">}</span>  
            
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>  
    <span class="o">}</span>  
<span class="o">}</span>  
</pre></table></code></div></div></ul><h2 id="role-기반-인가authorization-처리">Role 기반 인가(Authorization) 처리</h2><ul><li>개요<ul><li>authority는 세분화된 접근 권한을 의미한다[<a href="https://jake-seo-dev.tistory.com/669" target="_blank">참고9</a>].<br /> ex) 쓰기 권한, 읽기 권한<li>role은 권한 보다 높은 수준의 권한 그룹이다.<br /> ex) 일반유저, 관리자<li>spring security 6에서는 Role을 체크하여<br /> 페이지 접근을 제어하는 기능을 제공한다[<a href="https://jaykaybaek.tistory.com/30" target="_blank">참고10</a>].<li>spring에서 role은 보통 ROLE_로 시작한다.</ul><li>목표<ul><li>role은 ROLE_NORMAL, ROLE_ADMIN을 허용한다.<li>기본 유저는 role = ROLE_NORMAL 값을 갖는다.<li>/admin-info 페이지는 role = ROLE_ADMIN 유저만 접근할 수 있다.</ul><li>user/UserRole.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">enum</span> <span class="nc">UserRole</span> <span class="o">{</span>  
    <span class="no">ADMIN</span><span class="o">,</span> <span class="no">NORMAL</span><span class="o">;</span>  
<span class="o">}</span>  
</pre></table></code></div></div><li>user/User.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nd">@Document</span><span class="o">(</span><span class="n">collection</span> <span class="o">=</span> <span class="nc">MongodbCollectionName</span><span class="o">.</span><span class="na">USER</span><span class="o">)</span>  
<span class="nd">@Getter</span>  
<span class="nd">@Setter</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>  
    <span class="nd">@Id</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">_id</span><span class="o">;</span>  
            
    <span class="nd">@Indexed</span><span class="o">(</span><span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">openId</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">locale</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">provider</span><span class="o">;</span>  
    <span class="c1">// &gt;&gt;&gt;&gt;&gt; 추가 시작 &gt;&gt;&gt;&gt;&gt;  </span>
    <span class="kd">public</span> <span class="nc">UserRole</span> <span class="n">role</span><span class="o">;</span>  
    <span class="c1">// &lt;&lt;&lt;&lt;&lt; 추가 끝 &lt;&lt;&lt;&lt;&lt;  </span>
<span class="o">}</span>  
</pre></table></code></div></div><li>global/config/SecurityGroup.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>  
<span class="nd">@RequiredArgsConstructor</span>  
<span class="nd">@EnableWebSecurity</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityGroup</span> <span class="o">{</span>  
    <span class="nd">@Bean</span>  
    <span class="nc">SecurityFilterChain</span> <span class="nf">filterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>  
            
        <span class="c1">// @formatter:off  </span>
        <span class="n">http</span>  
            <span class="o">.</span><span class="na">csrf</span><span class="o">(</span><span class="nl">AbstractHttpConfigurer:</span><span class="o">:</span><span class="n">disable</span><span class="o">)</span>  
            <span class="o">.</span><span class="na">addFilterAfter</span><span class="o">(</span><span class="k">new</span> <span class="nc">AuthActiveFilter</span><span class="o">(),</span> <span class="nc">AuthorizationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>  
            <span class="o">.</span><span class="na">authorizeHttpRequests</span><span class="o">((</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">a</span>  
                            <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="s">"/private"</span><span class="o">).</span><span class="na">authenticated</span><span class="o">()</span>  
                            <span class="c1">// &gt;&gt;&gt;&gt;&gt; 추가 시작 &gt;&gt;&gt;&gt;&gt;  </span>
                            <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="s">"/admin-info"</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="nc">UserRole</span><span class="o">.</span><span class="na">ADMIN</span><span class="o">.</span><span class="na">toString</span><span class="o">())</span>  
                            <span class="c1">// &lt;&lt;&lt;&lt;&lt; 추가 끝 &lt;&lt;&lt;&lt;&lt;  </span>
                            <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">()</span>  
            <span class="o">)</span>  
            <span class="o">...</span>  
        <span class="c1">// @formatter:on  </span>
            
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>  
    <span class="o">}</span>  
<span class="o">}</span>  
</pre></table></code></div></div><li>oauth/OAuth2UserService.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="nd">@RequiredArgsConstructor</span>  
<span class="nd">@Service</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2UserService</span> <span class="kd">extends</span> <span class="nc">DefaultOAuth2UserService</span> <span class="o">{</span>  
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>  
            
    <span class="nd">@Override</span>  
    <span class="kd">public</span> <span class="nc">OAuth2User</span> <span class="nf">loadUser</span><span class="o">(</span><span class="nc">OAuth2UserRequest</span> <span class="n">userRequest</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">OAuth2AuthenticationException</span> <span class="o">{</span>  
        <span class="nc">OAuth2User</span> <span class="n">oAuth2User</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">loadUser</span><span class="o">(</span><span class="n">userRequest</span><span class="o">);</span>  
        <span class="c1">// System.out.println("oAuth2User = " + oAuth2User.getAttributes());  </span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">oAuth2User</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">();</span>  
            
        <span class="nc">String</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">getClientRegistration</span><span class="o">().</span><span class="na">getRegistrationId</span><span class="o">();</span>  
            
        <span class="c1">// 유효성 검사  </span>
        <span class="n">validateAttributes</span><span class="o">(</span><span class="n">attributes</span><span class="o">);</span>  
            
        <span class="c1">// 유저 획득  </span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">saveNewUser</span><span class="o">(</span><span class="n">attributes</span><span class="o">,</span> <span class="n">provider</span><span class="o">);</span>  
            
        <span class="c1">// &gt;&gt;&gt;&gt;&gt; 추가 시작 &gt;&gt;&gt;&gt;&gt;  </span>
        <span class="c1">// Role 할당  </span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>  
        <span class="nc">String</span> <span class="n">authority</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getRole</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>  
        <span class="n">authorities</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">"ROLE_"</span> <span class="o">+</span> <span class="n">authority</span><span class="o">));</span>  
        <span class="c1">// &lt;&lt;&lt;&lt;&lt; 추가 끝 &lt;&lt;&lt;&lt;&lt;  </span>
            
        <span class="c1">// 고유값 키 할당; default = "sub"  </span>
        <span class="nc">String</span> <span class="n">userNameAttributeName</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">getClientRegistration</span><span class="o">().</span><span class="na">getProviderDetails</span><span class="o">().</span><span class="na">getUserInfoEndpoint</span><span class="o">()</span>  
                <span class="o">.</span><span class="na">getUserNameAttributeName</span><span class="o">();</span>  
            
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultOAuth2User</span><span class="o">(</span><span class="n">authorities</span><span class="o">,</span> <span class="n">attributes</span><span class="o">,</span> <span class="n">userNameAttributeName</span><span class="o">);</span>  
    <span class="o">}</span>  
            
    <span class="kd">private</span> <span class="nc">User</span> <span class="nf">saveNewUser</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">,</span> <span class="nc">String</span> <span class="n">provider</span><span class="o">)</span> <span class="o">{</span>  
        <span class="nc">String</span> <span class="n">email</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">);</span>  
        <span class="nc">String</span> <span class="n">openId</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="s">"sub"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>  
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>  
        <span class="nc">String</span> <span class="n">locale</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="s">"locale"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>  
            
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>  
        <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  
            <span class="nc">User</span> <span class="n">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setOpenId</span><span class="o">(</span><span class="n">openId</span><span class="o">);</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setLocale</span><span class="o">(</span><span class="n">locale</span><span class="o">);</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setProvider</span><span class="o">(</span><span class="n">provider</span><span class="o">);</span>  
            <span class="c1">// &gt;&gt;&gt;&gt;&gt; 추가 시작 &gt;&gt;&gt;&gt;&gt;  </span>
            <span class="n">newUser</span><span class="o">.</span><span class="na">setRole</span><span class="o">(</span><span class="nc">UserRole</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">);</span>  
            <span class="c1">// &lt;&lt;&lt;&lt;&lt; 추가 끝 &lt;&lt;&lt;&lt;&lt;  </span>
            <span class="nc">User</span> <span class="n">createdUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">newUser</span><span class="o">);</span>  
            
            <span class="k">return</span> <span class="n">createdUser</span><span class="o">;</span>  
        <span class="o">}</span>  
            
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>  
    <span class="o">}</span>  
<span class="o">}</span>  
</pre></table></code></div></div></ul><h2 id="custom-인가-처리">Custom 인가 처리</h2><ul><li>개요<ul><li>User에 isActive 속성을 추가한다.<li>isActive 속성이 true이면 로그인을 허가하고<br /> false 이면 로그인을 불허한다.<li>servlet filter를 이용하여 구현한다[<a href="https://curiousjinan.tistory.com/entry/spring-filterchain-dofilter" target="_blank">참고11</a>].</ul><li>user/User.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre> <span class="c1">// &gt;&gt;&gt;&gt;&gt; 추가 시작 &gt;&gt;&gt;&gt;&gt;  </span>
<span class="nd">@FieldNameConstants</span>  
<span class="c1">// &lt;&lt;&lt;&lt;&lt; 추가 끝 &lt;&lt;&lt;&lt;&lt;  </span>
<span class="nd">@Document</span><span class="o">(</span><span class="n">collection</span> <span class="o">=</span> <span class="nc">MongodbCollectionName</span><span class="o">.</span><span class="na">USER</span><span class="o">)</span>  
<span class="nd">@Getter</span>  
<span class="nd">@Setter</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>  
    <span class="nd">@Id</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">_id</span><span class="o">;</span>  
            
    <span class="nd">@Indexed</span><span class="o">(</span><span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">openId</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">locale</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="n">provider</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nc">UserRole</span> <span class="n">role</span><span class="o">;</span>  
    <span class="c1">// &gt;&gt;&gt;&gt;&gt; 추가 시작 &gt;&gt;&gt;&gt;&gt;  </span>
    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="n">isActive</span><span class="o">;</span>  
    <span class="c1">// &lt;&lt;&lt;&lt;&lt; 추가 끝 &lt;&lt;&lt;&lt;&lt;  </span>
<span class="o">}</span>  
</pre></table></code></div></div><li>oauth/OAuth2UserKey.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">enum</span> <span class="nc">OAuth2UserKey</span> <span class="o">{</span>  
    <span class="no">IS_ACTIVE</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">Fields</span><span class="o">.</span><span class="na">isActive</span><span class="o">);</span>  
            
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">value</span><span class="o">;</span>  
            
    <span class="kd">private</span> <span class="nf">OAuth2UserKey</span><span class="o">(</span><span class="nc">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>  
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>  
    <span class="o">}</span>  
            
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>  
    <span class="o">}</span>  
<span class="o">}</span>  
</pre></table></code></div></div><li>oauth/OAuth2UserService.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre><td class="rouge-code"><pre><span class="nd">@RequiredArgsConstructor</span>  
<span class="nd">@Service</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2UserService</span> <span class="kd">extends</span> <span class="nc">DefaultOAuth2UserService</span> <span class="o">{</span>  
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>  
            
    <span class="nd">@Override</span>  
    <span class="kd">public</span> <span class="nc">OAuth2User</span> <span class="nf">loadUser</span><span class="o">(</span><span class="nc">OAuth2UserRequest</span> <span class="n">userRequest</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">OAuth2AuthenticationException</span> <span class="o">{</span>  
        <span class="nc">OAuth2User</span> <span class="n">oAuth2User</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">loadUser</span><span class="o">(</span><span class="n">userRequest</span><span class="o">);</span>  
        <span class="c1">// System.out.println("oAuth2User = " + oAuth2User.getAttributes());  </span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">oAuth2User</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">();</span>  
            
        <span class="nc">String</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">getClientRegistration</span><span class="o">().</span><span class="na">getRegistrationId</span><span class="o">();</span>  
            
        <span class="c1">// 유효성 검사  </span>
        <span class="n">validateAttributes</span><span class="o">(</span><span class="n">attributes</span><span class="o">);</span>  
            
        <span class="c1">// 유저 획득  </span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">saveNewUser</span><span class="o">(</span><span class="n">attributes</span><span class="o">,</span> <span class="n">provider</span><span class="o">);</span>  
            
        <span class="c1">// Role 할당  </span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>  
        <span class="nc">String</span> <span class="n">authority</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getRole</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>  
        <span class="n">authorities</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">"ROLE_"</span> <span class="o">+</span> <span class="n">authority</span><span class="o">));</span>  
            
        <span class="c1">// 고유값 키 할당; default = "sub"  </span>
        <span class="nc">String</span> <span class="n">userNameAttributeName</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">getClientRegistration</span><span class="o">().</span><span class="na">getProviderDetails</span><span class="o">().</span><span class="na">getUserInfoEndpoint</span><span class="o">()</span>  
                <span class="o">.</span><span class="na">getUserNameAttributeName</span><span class="o">();</span>  
            
        <span class="c1">// &gt;&gt;&gt;&gt;&gt; 추가 시작 &gt;&gt;&gt;&gt;&gt;  </span>
        <span class="n">attributes</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">OAuth2UserKey</span><span class="o">.</span><span class="na">IS_ACTIVE</span><span class="o">.</span><span class="na">getValue</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getIsActive</span><span class="o">());</span>  
        <span class="c1">// &lt;&lt;&lt;&lt;&lt; 추가 끝 &lt;&lt;&lt;&lt;&lt;  </span>
            
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultOAuth2User</span><span class="o">(</span><span class="n">authorities</span><span class="o">,</span> <span class="n">newAttributes</span><span class="o">,</span> <span class="n">userNameAttributeName</span><span class="o">);</span>  
    <span class="o">}</span>  
            
    <span class="kd">private</span> <span class="nc">User</span> <span class="nf">saveNewUser</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">,</span> <span class="nc">String</span> <span class="n">provider</span><span class="o">)</span> <span class="o">{</span>  
        <span class="nc">String</span> <span class="n">email</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">);</span>  
        <span class="nc">String</span> <span class="n">openId</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="s">"sub"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>  
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>  
        <span class="nc">String</span> <span class="n">locale</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="s">"locale"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>  
            
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>  
        <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  
            <span class="nc">User</span> <span class="n">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setOpenId</span><span class="o">(</span><span class="n">openId</span><span class="o">);</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setLocale</span><span class="o">(</span><span class="n">locale</span><span class="o">);</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setProvider</span><span class="o">(</span><span class="n">provider</span><span class="o">);</span>  
            <span class="n">newUser</span><span class="o">.</span><span class="na">setRole</span><span class="o">(</span><span class="nc">UserRole</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">);</span>  
            <span class="c1">// &gt;&gt;&gt;&gt;&gt; 추가 시작 &gt;&gt;&gt;&gt;&gt;  </span>
            <span class="n">newUser</span><span class="o">.</span><span class="na">setIsActive</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  
            <span class="c1">// &lt;&lt;&lt;&lt;&lt; 추가 끝 &lt;&lt;&lt;&lt;&lt;  </span>
            <span class="nc">User</span> <span class="n">createdUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">newUser</span><span class="o">);</span>  
            
            <span class="k">return</span> <span class="n">createdUser</span><span class="o">;</span>  
        <span class="o">}</span>  
            
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>  
    <span class="o">}</span>  
<span class="o">}</span>  
</pre></table></code></div></div><li>oauth/AuthActiveFilter.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthActiveFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>  
    <span class="nd">@Override</span>  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">servletRequest</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">servletResponse</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span>  
            <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>  
        <span class="nc">HttpServletResponse</span> <span class="n">resp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">)</span> <span class="n">servletResponse</span><span class="o">;</span>  
        <span class="nc">HttpServletRequest</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletRequest</span><span class="o">)</span> <span class="n">servletRequest</span><span class="o">;</span>  
        <span class="nc">OAuth2AuthenticationToken</span> <span class="n">authToken</span> <span class="o">=</span> <span class="o">(</span><span class="nc">OAuth2AuthenticationToken</span><span class="o">)</span> <span class="n">req</span><span class="o">.</span><span class="na">getUserPrincipal</span><span class="o">();</span>  
        <span class="k">if</span> <span class="o">(</span><span class="n">authToken</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  
            <span class="kt">boolean</span> <span class="n">isActive</span> <span class="o">=</span> <span class="n">authToken</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="nc">OAuth2UserKey</span><span class="o">.</span><span class="na">IS_ACTIVE</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>  
            <span class="kt">boolean</span> <span class="n">isAuthenticated</span> <span class="o">=</span> <span class="n">authToken</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">();</span>  
            
            <span class="c1">// 로그인은 성공, isActivate = false  </span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isAuthenticated</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isActive</span><span class="o">)</span> <span class="o">{</span>  
                <span class="n">resp</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_UNAUTHORIZED</span><span class="o">,</span> <span class="s">"your account has been banned"</span><span class="o">);</span>  
                <span class="k">return</span><span class="o">;</span>  
            <span class="o">}</span>  
            
        <span class="o">}</span>  
            
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">servletRequest</span><span class="o">,</span> <span class="n">servletResponse</span><span class="o">);</span>  
    <span class="o">}</span>  
<span class="o">}</span>  
</pre></table></code></div></div><li>global/config/SecurityGroup.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>  
<span class="nd">@RequiredArgsConstructor</span>  
<span class="nd">@EnableWebSecurity</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityGroup</span> <span class="o">{</span>  
    <span class="nd">@Bean</span>  
    <span class="nc">SecurityFilterChain</span> <span class="nf">filterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>  
            
        <span class="c1">// @formatter:off  </span>
        <span class="n">http</span>  
            <span class="o">.</span><span class="na">csrf</span><span class="o">(</span><span class="nl">AbstractHttpConfigurer:</span><span class="o">:</span><span class="n">disable</span><span class="o">)</span>  
            <span class="c1">// &gt;&gt;&gt;&gt;&gt; 추가 시작 &gt;&gt;&gt;&gt;&gt;  </span>
            <span class="o">.</span><span class="na">addFilterAfter</span><span class="o">(</span><span class="k">new</span> <span class="nc">AuthActiveFilter</span><span class="o">(),</span> <span class="nc">AuthorizationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>  
            <span class="c1">// &lt;&lt;&lt;&lt;&lt; 추가 끝 &lt;&lt;&lt;&lt;&lt;  </span>
            <span class="o">.</span><span class="na">authorizeHttpRequests</span><span class="o">((</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span>   
                            <span class="o">...</span>  
            <span class="o">)</span>  
            <span class="o">...</span>  
        <span class="c1">// @formatter:on  </span>
            
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>  
</pre></table></code></div></div><ul><li>AuthActivateFilter는 인증 및 인가 과정 중 가장 마지막에 실행되어야 한다.<li>@EnableWebSecurity(debug = true) 설정을 추가하면<br /> Spring security 6에서 추가한 필터 목록을 볼 수 있다[<a href="https://www.baeldung.com/spring-security-registered-filters" target="_blank">참고12</a>].<li>가장 마지막에 추가된 필터(예시에서는 AuthorizationFilter) 실행 후에<br /> AuthActivateFilter를 추가하면 된다.</ul></ul><h2 id="로그아웃">로그아웃</h2><ul><li>개요<ul><li>기본 로그아웃 url<ul><li>/logout</ul><li>로그아웃 성공 시 redirect_uri를 지정한다[<a href="https://docs.spring.io/spring-security/reference/reactive/oauth2/login/logout.html#oauth2login-advanced-oidc-logout" target="_blank">참고13</a>].<li>해당 페이지에서 세션 쿠키를 제거한다.</ul><li>oauth/AuthController.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nd">@RestController</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthController</span> <span class="o">{</span>  
    <span class="o">....</span>  
     <span class="c1">// &gt;&gt;&gt;&gt;&gt; 추가 시작 &gt;&gt;&gt;&gt;&gt;  </span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/auth/logout"</span><span class="o">)</span>  
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">logoutSucessful</span><span class="o">()</span> <span class="o">{</span>  
        <span class="nc">HttpSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>  
        <span class="k">if</span> <span class="o">(</span><span class="n">session</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  
            <span class="n">session</span><span class="o">.</span><span class="na">invalidate</span><span class="o">();</span>  
        <span class="o">}</span>  
            
        <span class="k">return</span> <span class="s">"logout"</span><span class="o">;</span>  
    <span class="o">}</span>  
     <span class="c1">// &lt;&lt;&lt;&lt;&lt; 추가 끝 &lt;&lt;&lt;&lt;&lt;  </span>
<span class="o">}</span>  
</pre></table></code></div></div><li>global/config/SecurityGroup.java<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>  
<span class="nd">@RequiredArgsConstructor</span>  
<span class="nd">@EnableWebSecurity</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityGroup</span> <span class="o">{</span>  
    <span class="nd">@Bean</span>  
    <span class="nc">SecurityFilterChain</span> <span class="nf">filterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>  
            
        <span class="c1">// @formatter:off  </span>
        <span class="n">http</span>  
            <span class="o">...</span>  
             <span class="c1">// &gt;&gt;&gt;&gt;&gt; 추가 시작 &gt;&gt;&gt;&gt;&gt;  </span>
            <span class="o">.</span><span class="na">logout</span><span class="o">(</span><span class="n">l</span> <span class="o">-&gt;</span> <span class="n">l</span>  
                    <span class="o">.</span><span class="na">logoutSuccessUrl</span><span class="o">(</span><span class="s">"/auth/logout"</span><span class="o">)</span>  
            <span class="o">)</span>  
            <span class="o">;</span>  
             <span class="c1">// &lt;&lt;&lt;&lt;&lt; 추가 끝 &lt;&lt;&lt;&lt;&lt;  </span>
        <span class="c1">// @formatter:on  </span>
            
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>  
    <span class="o">}</span>  
<span class="o">}</span>  
</pre></table></code></div></div></ul><h2 id="참고">참고</h2><ul><li><a href="https://ko.wikipedia.org/wiki/OAuth" target="_blank">참고1 - OAuth</a><li><a href="https://developers.google.com/identity/protocols/oauth2/javascript-implicit-flow?hl=ko" target="_blank">참고2 - 클라이언트 측 웹 애플리케이션용 OAuth 2.0 </a><li><a href="https://notspoon.tistory.com/47" target="_blank">참고3 - 구글 로그인 쉽게 구현하기 3편 - 로그인 구현하기 (SpringBoot + Vue.js)</a><li><a href="https://growth-coder.tistory.com/135" target="_blank">참고4 - [Spring] 스프링 Oauth2 구글 로그인과 jpa 사용하여 유저 정보 데이터베이스에 저장 (OAuth2 스프링 1편)</a><li><a href="https://spring.io/guides/tutorials/spring-boot-oauth2#_social_login_simple" target="_blank">참고5 - Single Sign On With GitHub</a><li><a href="https://docs.spring.io/spring-security/reference/servlet/oauth2/login/core.html#oauth2login-sample-boot" target="_blank">참고6 - Core Configuration</a><li><a href="https://docs.spring.io/spring-security/reference/servlet/oauth2/index.html#oauth2-client" target="_blank">참고7 - OAuth2 Client</a><li><a href="https://codediary21.tistory.com/73" target="_blank">참고8 - (Spring Security) OAuth2 서비스 구현 정리</a><li><a href="https://jake-seo-dev.tistory.com/669" target="_blank">참고9 - 스프링 시큐리티에서 Authority 와 Role 의 차이는?</a><li><a href="https://jaykaybaek.tistory.com/30" target="_blank">참고10 - [Spring Security] 인증(Authentication), 인가(Authorization), 권한(Authority), 역할(Role) 알아보기</a><li><a href="https://curiousjinan.tistory.com/entry/spring-filterchain-dofilter" target="_blank">참고11 - Spring Boot: 필터에서 doFilter와 FilterChain이란?</a><li><a href="https://www.baeldung.com/spring-security-registered-filters" target="_blank">참고12 - Find the Registered Spring Security Filters</a><li><a href="https://docs.spring.io/spring-security/reference/reactive/oauth2/login/logout.html#oauth2login-advanced-oidc-logout" target="_blank">참고13 - OpenID Connect 1.0 Client-Initiated Logout</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/spring/'>Spring</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring/" class="post-tag no-text-decoration" >spring</a> <a href="/tags/spring-security/" class="post-tag no-text-decoration" >spring-security</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=spring security 6에서 oauth2.0 구현하기(google) - 의사줌치&url=https://a3magic3pocket.github.io/posts/spring-security-6-oauth2-google/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=spring security 6에서 oauth2.0 구현하기(google) - 의사줌치&u=https://a3magic3pocket.github.io/posts/spring-security-6-oauth2-google/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=spring security 6에서 oauth2.0 구현하기(google) - 의사줌치&url=https://a3magic3pocket.github.io/posts/spring-security-6-oauth2-google/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/kafka-large-scale-event-processing-architecture-and-performance-comparison/">Kafka를 활용한 대용량 이벤트 처리 구조 설계와 성능 비교</a><li><a href="/posts/experimenting-with-blue-green-deployments/">블루 - 그린 배포 실험</a><li><a href="/posts/spring-kafka-latest-message-pub-sub-config/">Spring Kafka에서 최신 메시지만 소비하는 Pub/Sub 방식 설정</a><li><a href="/posts/solving-concurrency-problems-with-performance-in-mind/">동시성 문제 해결 방안 성능 실험</a><li><a href="/posts/exploring-authentication-options/">인증방식 고민</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/kafka/">kafka</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/elasticsearch/">elasticsearch</a> <a class="post-tag" href="/tags/elk/">elk</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/summary/">summary</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/kafka-streams/">kafka-streams</a> <a class="post-tag" href="/tags/nest/">nest</a> <a class="post-tag" href="/tags/react/">react</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/kafka-large-scale-event-processing-architecture-and-performance-comparison/"><div class="card-body"> <span class="timeago small" > Apr 11 <i class="unloaded">2025-04-11T22:30:12+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kafka를 활용한 대용량 이벤트 처리 구조 설계와 성능 비교</h3><div class="text-muted small"><p> 목적 서비스에서 처리량이 증가하거나 작업 시간이 길어지는 상황에서 기존의 동기식 직접 DB 접근방식이 가진 한계를 확인하고 Kafka 기반 비동기 처리 구조의 성능 및 안정성을 확인하기 위함 실험환경 애플리케이션Kotlin Spring Boot 기반 API 서버 DB: MariaDB Kafka: 단일 노드 트랜잭션 타임아웃...</p></div></div></a></div><div class="card"> <a href="/posts/spring-kafka-multithreaded-consumer-config/"><div class="card-body"> <span class="timeago small" > Apr 11 <i class="unloaded">2025-04-11T22:31:49+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Kafka 컨슈머 멀티스레드 처리 설정</h3><div class="text-muted small"><p> 개요 Spring Kafka의 @KafkaListener 어노테이션에서 concurrency 속성을 설정하면, 리스너 컨테이너가 해당 수만큼의 스레드를 생성하여 동일한 리스너 로직을 병렬로 실행하며 메시지를 처리한다. 가정 도커로 카프카 컨테이너 한 개를 띄운다. 스프링으로 카프카와 소통한다. 스프링 카프카 의존성 및 스프링 의...</p></div></div></a></div><div class="card"> <a href="/posts/kafka-jsonserializer/"><div class="card-body"> <span class="timeago small" > Mar 27, 2024 <i class="unloaded">2024-03-27T16:35:51+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>카프카, JsonSerializer 사용하기</h3><div class="text-muted small"><p> 개요 카프카 생산자(producer) value serializer를 JsonSerializer로 설정한다. 카프카 소비자(consumer) value deserializer를 JsonDeserializer로 설정한다. 소비자 그룹마다 다른 json을 message로 받을 수 있도록 한다. 환경 java 21 spring ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/kafka-exactly-once/" class="btn btn-outline-primary" prompt="Older"><p>카프카, 정확히 한 번(kafka, exactly once)</p></a> <a href="/posts/kafka-jsonserializer/" class="btn btn-outline-primary" prompt="Newer"><p>카프카, JsonSerializer 사용하기</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/a3magic3pocket">의사줌치</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/kafka/">kafka</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/elasticsearch/">elasticsearch</a> <a class="post-tag" href="/tags/elk/">elk</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/summary/">summary</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/kafka-streams/">kafka streams</a> <a class="post-tag" href="/tags/nest/">nest</a> <a class="post-tag" href="/tags/react/">react</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://a3magic3pocket.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
