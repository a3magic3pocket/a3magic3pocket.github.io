<!DOCTYPE html><html lang="ko-KR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="solana DApp 인증 구현" /><meta property="og:locale" content="ko_KR" /><meta name="description" content="개요 solana DAPP에서 지갑인증을 구현해본다. 지갑으로 인증된 유저만 특정 페이지를 조회할 수 있도록 처리할 수 있다. How to Integrate Sign-in Authentication with a Solana Wallet을 그대로 따라 진행한다. 중요한 부분만 설명을 추가한다." /><meta property="og:description" content="개요 solana DAPP에서 지갑인증을 구현해본다. 지갑으로 인증된 유저만 특정 페이지를 조회할 수 있도록 처리할 수 있다. How to Integrate Sign-in Authentication with a Solana Wallet을 그대로 따라 진행한다. 중요한 부분만 설명을 추가한다." /><link rel="canonical" href="https://a3magic3pocket.github.io/posts/solana-wallet-signin/" /><meta property="og:url" content="https://a3magic3pocket.github.io/posts/solana-wallet-signin/" /><meta property="og:site_name" content="의사줌치" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-02-19T10:48:24+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="solana DApp 인증 구현" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"개요 solana DAPP에서 지갑인증을 구현해본다. 지갑으로 인증된 유저만 특정 페이지를 조회할 수 있도록 처리할 수 있다. How to Integrate Sign-in Authentication with a Solana Wallet을 그대로 따라 진행한다. 중요한 부분만 설명을 추가한다.","url":"https://a3magic3pocket.github.io/posts/solana-wallet-signin/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://a3magic3pocket.github.io/posts/solana-wallet-signin/"},"headline":"solana DApp 인증 구현","dateModified":"2024-02-19T12:18:35+09:00","datePublished":"2024-02-19T10:48:24+09:00","@context":"https://schema.org"}</script><title>solana DApp 인증 구현 | 의사줌치</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="의사줌치"><meta name="application-name" content="의사줌치"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-5NQ41XXW83"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-5NQ41XXW83'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/sample/avatar-crop.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">의사줌치</a></div><div class="site-subtitle font-italic">부정확한 정보를 <br /> 담고 있을 수 있습니다.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/a3magic3pocket" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['a3magic3pocket','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>solana DApp 인증 구현</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>solana DApp 인증 구현</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> 의사줌치 </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Feb 19, 2024, 10:48 AM +0900" prep="on" > Feb 19, 2024 <i class="unloaded">2024-02-19T10:48:24+09:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Feb 19, 2024, 12:18 PM +0900" prefix="Updated " > Feb 19, 2024 <i class="unloaded">2024-02-19T12:18:35+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1803 words">10 min</span></div></div><div class="post-content"><h2 id="개요">개요</h2><ul><li>solana DAPP에서 지갑인증을 구현해본다.<li>지갑으로 인증된 유저만 특정 페이지를 <br /> 조회할 수 있도록 처리할 수 있다.<li><a href="https://www.quicknode.com/guides/solana-development/dapps/how-to-authenticate-users-with-a-solana-wallet" target="_blank">How to Integrate Sign-in Authentication with a Solana Wallet</a>을 그대로 따라 진행한다.<li>중요한 부분만 설명을 추가한다.</ul><h2 id="환경">환경</h2><ul><li>next.js로 DApp을 구현하였다.<li>인증 시 사용하는 api는 next.js의 API 기능을 사용한다.<li>NextAuth.js를 이용하여 인증을 구현한다.</ul><h2 id="인증-원리">인증 원리</h2><ul><li>지갑의 전자서명(signMessage(data)) 기능을 이용한다.<li>지갑에는 유저의 공개키와 비밀키가 저장되어있다.<li>지갑에 저장되어 있는 비밀키로 메세지를 암호화한다.<br /> 이를 서명(signature)이라고 한다.<li>유저는 (메세지, 서명, 공개키)를 인증 서버에 전달한다.<li>인증서버는 서명을 공개키로 복호화한다.<li>복호화된 메세지가 전달 받은 메세지와 일치하면<br /> 인증을 요청한 지갑이 전달 받은 공개키 지갑이라는 것을 확인할 수 있다.</ul><h2 id="signinmessagets">SigninMessage.ts</h2><ul><li>설명<ul><li>인증 시 필요한 정보를 담고 있는 클래스이다.</ul><li>프로퍼티 설명<ul><li>domain<ul><li>인증 요청 URL, 허가된 곳에서 요청했는지 확인할때 사용한다.</ul><li>publicKey<ul><li>지갑의 공개키</ul><li>nonce:<ul><li>랜덤 문자열로 메세지가 중복되는 것을 막는다.</ul><li>statement<ul><li>인증 시 사용하는 문자열<br /> 아무 문자나 적어도 된다.</ul></ul><li>prepare 메서드 설명<ul><li>statement와 nonce를 이어붙여 메세지를 만든다.</ul><li>validate 메서드 설명<ul><li>메세지, 서명, 공개키를 이용하여 공개키 주인이 보낸 메세지인지 확인한다.<li><a href="https://github.com/dchest/tweetnacl-js/blob/master/README.md#naclsigndetachedverifymessage-signature-publickey" target="_blank">nacl.sign.detached.verify 함수 설명</a></ul><li>코드<div class="language-typescript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre>            
<span class="cm">/* Reference by : https://www.quicknode.com/guides/solana-development/dapps/how-to-authenticate-users-with-a-solana-wallet#create-a-sign-in-message-class */</span>  
            
<span class="k">import</span> <span class="nx">bs58</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">bs58</span><span class="dl">"</span><span class="p">;</span>  
<span class="k">import</span> <span class="nx">nacl</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">tweetnacl</span><span class="dl">"</span><span class="p">;</span>  
<span class="kd">type</span> <span class="nx">SignMessage</span> <span class="o">=</span> <span class="p">{</span>  
  <span class="na">domain</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>  
  <span class="nl">publicKey</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>  
  <span class="nl">nonce</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>  
  <span class="nl">statement</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>  
<span class="p">};</span>  
            
<span class="k">export</span> <span class="kd">class</span> <span class="nx">SigninMessage</span> <span class="p">{</span>  
  <span class="nl">domain</span><span class="p">:</span> <span class="kr">any</span><span class="p">;</span>  
  <span class="nl">publicKey</span><span class="p">:</span> <span class="kr">any</span><span class="p">;</span>  
  <span class="nl">nonce</span><span class="p">:</span> <span class="kr">any</span><span class="p">;</span>  
  <span class="nl">statement</span><span class="p">:</span> <span class="kr">any</span><span class="p">;</span>  
            
  <span class="kd">constructor</span><span class="p">({</span> <span class="nx">domain</span><span class="p">,</span> <span class="nx">publicKey</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">,</span> <span class="nx">statement</span> <span class="p">}:</span> <span class="nx">SignMessage</span><span class="p">)</span> <span class="p">{</span>  
    <span class="k">this</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">;</span>  
    <span class="k">this</span><span class="p">.</span><span class="nx">publicKey</span> <span class="o">=</span> <span class="nx">publicKey</span><span class="p">;</span>  
    <span class="k">this</span><span class="p">.</span><span class="nx">nonce</span> <span class="o">=</span> <span class="nx">nonce</span><span class="p">;</span>  
    <span class="k">this</span><span class="p">.</span><span class="nx">statement</span> <span class="o">=</span> <span class="nx">statement</span><span class="p">;</span>  
  <span class="p">}</span>  
            
  <span class="nx">prepare</span><span class="p">()</span> <span class="p">{</span>  
    <span class="k">return</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">statement</span><span class="p">}${</span><span class="k">this</span><span class="p">.</span><span class="nx">nonce</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>  
  <span class="p">}</span>  
            
  <span class="k">async</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">signature</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>  
    <span class="kd">const</span> <span class="nx">msg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">prepare</span><span class="p">();</span>  
    <span class="kd">const</span> <span class="nx">signatureUint8</span> <span class="o">=</span> <span class="nx">bs58</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">signature</span><span class="p">);</span>  
    <span class="kd">const</span> <span class="nx">msgUint8</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TextEncoder</span><span class="p">().</span><span class="nx">encode</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>  
    <span class="kd">const</span> <span class="nx">pubKeyUint8</span> <span class="o">=</span> <span class="nx">bs58</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">);</span>  
            
    <span class="k">return</span> <span class="nx">nacl</span><span class="p">.</span><span class="nx">sign</span><span class="p">.</span><span class="nx">detached</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">msgUint8</span><span class="p">,</span> <span class="nx">signatureUint8</span><span class="p">,</span> <span class="nx">pubKeyUint8</span><span class="p">);</span>  
  <span class="p">}</span>  
            
<span class="p">}</span>  
            
</pre></table></code></div></div></ul><h2 id="solana-wallet-adapter-추가">Solana Wallet Adapter 추가</h2><ul><li>설명<ul><li>next.js 앱에서 SessionProvider를 추가한다.<li>나머지는 solana 지갑관련된 것으로<br /> 기호에 따라 변경할 수 있다.<br /> (예시에서는 PhantomWallet만 지원하고 있다.)</ul><li>코드<div class="language-typescript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre>            
<span class="cm">/* Reference by: https://www.quicknode.com/guides/solana-development/dapps/how-to-authenticate-users-with-a-solana-wallet#add-the-solana-wallet-adapter */</span>  
            
<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">App</span><span class="p">({</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">pageProps</span> <span class="p">}:</span> <span class="nx">AppProps</span><span class="p">)</span> <span class="p">{</span>  
  <span class="kd">const</span> <span class="nx">network</span> <span class="o">=</span> <span class="nx">WalletAdapterNetwork</span><span class="p">.</span><span class="nx">Devnet</span><span class="p">;</span>  
  <span class="kd">const</span> <span class="nx">endpoint</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">clusterApiUrl</span><span class="p">(</span><span class="nx">network</span><span class="p">),</span> <span class="p">[</span><span class="nx">network</span><span class="p">]);</span>  
              
  <span class="kd">const</span> <span class="nx">wallets</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(</span>  
    <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">[</span>  
      <span class="k">new</span> <span class="nx">PhantomWalletAdapter</span><span class="p">(),</span>  
    <span class="p">],</span>  
    <span class="p">[]</span>  
  <span class="p">);</span>  
            
  <span class="k">return</span> <span class="p">(</span>  
    <span class="o">&lt;</span><span class="nx">ConnectionProvider</span> <span class="nx">endpoint</span><span class="o">=</span><span class="p">{</span><span class="nx">endpoint</span><span class="p">}</span><span class="o">&gt;</span>  
      <span class="o">&lt;</span><span class="nx">WalletProvider</span> <span class="nx">wallets</span><span class="o">=</span><span class="p">{</span><span class="nx">wallets</span><span class="p">}</span> <span class="nx">autoConnect</span><span class="o">&gt;</span>  
        <span class="o">&lt;</span><span class="nx">WalletModalProvider</span><span class="o">&gt;</span>  
          <span class="c1">// 추가 시작  </span>
          <span class="o">&lt;</span><span class="nx">SessionProvider</span> <span class="nx">session</span><span class="o">=</span><span class="p">{</span><span class="nx">pageProps</span><span class="p">.</span><span class="nx">session</span><span class="p">}</span> <span class="nx">refetchInterval</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">&gt;</span>  
          <span class="c1">// 추가 끝  </span>
            <span class="o">&lt;</span><span class="nx">Component</span> <span class="p">{...</span><span class="nx">pageProps</span><span class="p">}</span> <span class="sr">/&gt; </span><span class="err"> 
</span>          <span class="c1">// 추가 시작  </span>
          <span class="o">&lt;</span><span class="sr">/SessionProvider&gt; </span><span class="err"> 
</span>          <span class="c1">// 추가 끝  </span>
        <span class="o">&lt;</span><span class="sr">/WalletModalProvider&gt; </span><span class="err"> 
</span>      <span class="o">&lt;</span><span class="sr">/WalletProvider&gt; </span><span class="err"> 
</span>    <span class="o">&lt;</span><span class="sr">/ConnectionProvider&gt; </span><span class="err"> 
</span>  <span class="p">);</span>  
<span class="p">}</span>  
            
</pre></table></code></div></div></ul><h2 id="프론트엔드">프론트엔드</h2><ul><li>설명<ul><li>인증 요청 버튼을 클릭하면<br /> domain, publicKey, statement, nonce를 이용하여<br /> SigninMessage 인스턴스를 생성한다.<li>nonce는 csrf 토큰으로 랜덤하다.<li>SingingMessage 인스턴스에서 prepare 메서드를 실행하여<br /> 메시지를 만든다.<li>wallet.signMessage(메세지)를 실행하여 서명을 만든다.<li>SigningMessage 인스턴스를 json으로 바꾸고, 서명과 함께<br /> 인증 서버로 요청한다.</ul><li>코드<div class="language-typescript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
</pre><td class="rouge-code"><pre>            
<span class="cm">/* Reference by: https://www.quicknode.com/guides/solana-development/dapps/how-to-authenticate-users-with-a-solana-wallet#update-front-end */</span>  
            
<span class="k">import</span> <span class="nx">Link</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">next/link</span><span class="dl">"</span><span class="p">;</span>  
<span class="k">import</span> <span class="p">{</span> <span class="nx">getCsrfToken</span><span class="p">,</span> <span class="nx">signIn</span><span class="p">,</span> <span class="nx">signOut</span><span class="p">,</span> <span class="nx">useSession</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">next-auth/react</span><span class="dl">"</span><span class="p">;</span>  
<span class="k">import</span> <span class="nx">styles</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./header.module.css</span><span class="dl">"</span><span class="p">;</span>  
<span class="k">import</span> <span class="p">{</span> <span class="nx">useWalletModal</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@solana/wallet-adapter-react-ui</span><span class="dl">"</span><span class="p">;</span>  
<span class="k">import</span> <span class="p">{</span> <span class="nx">useWallet</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@solana/wallet-adapter-react</span><span class="dl">"</span><span class="p">;</span>  
<span class="k">import</span> <span class="p">{</span> <span class="nx">SigninMessage</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../utils/SigninMessage</span><span class="dl">"</span><span class="p">;</span>  
<span class="k">import</span> <span class="nx">bs58</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">bs58</span><span class="dl">"</span><span class="p">;</span>  
<span class="k">import</span> <span class="p">{</span> <span class="nx">useEffect</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react</span><span class="dl">"</span><span class="p">;</span>  
            
<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">Header</span><span class="p">()</span> <span class="p">{</span>  
  <span class="kd">const</span> <span class="p">{</span> <span class="na">data</span><span class="p">:</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">status</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useSession</span><span class="p">();</span>  
  <span class="kd">const</span> <span class="nx">loading</span> <span class="o">=</span> <span class="nx">status</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">loading</span><span class="dl">"</span><span class="p">;</span>  
            
  <span class="kd">const</span> <span class="nx">wallet</span> <span class="o">=</span> <span class="nx">useWallet</span><span class="p">();</span>  
  <span class="kd">const</span> <span class="nx">walletModal</span> <span class="o">=</span> <span class="nx">useWalletModal</span><span class="p">();</span>  
            
  <span class="kd">const</span> <span class="nx">handleSignIn</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>  
    <span class="k">try</span> <span class="p">{</span>  
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">connected</span><span class="p">)</span> <span class="p">{</span>  
        <span class="nx">walletModal</span><span class="p">.</span><span class="nx">setVisible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>  
      <span class="p">}</span>  
            
      <span class="c1">// csrf 토큰 생성  </span>
      <span class="kd">const</span> <span class="nx">csrf</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getCsrfToken</span><span class="p">();</span>  
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span> <span class="o">||</span> <span class="o">!</span><span class="nx">csrf</span> <span class="o">||</span> <span class="o">!</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">signMessage</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>  
            
      <span class="c1">// SigninMessage 인스턴스 생성  </span>
      <span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SigninMessage</span><span class="p">({</span>  
        <span class="na">domain</span><span class="p">:</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span>  
        <span class="na">publicKey</span><span class="p">:</span> <span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">?.</span><span class="nx">toBase58</span><span class="p">(),</span>  
        <span class="na">statement</span><span class="p">:</span> <span class="s2">`Sign this message to sign in to the app.`</span><span class="p">,</span>  
        <span class="na">nonce</span><span class="p">:</span> <span class="nx">csrf</span><span class="p">,</span>  
      <span class="p">});</span>  
            
      <span class="c1">// 서명 생성  </span>
      <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TextEncoder</span><span class="p">().</span><span class="nx">encode</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">prepare</span><span class="p">());</span>  
      <span class="kd">const</span> <span class="nx">signature</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">wallet</span><span class="p">.</span><span class="nx">signMessage</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>  
      <span class="kd">const</span> <span class="nx">serializedSignature</span> <span class="o">=</span> <span class="nx">bs58</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">signature</span><span class="p">);</span>  
            
      <span class="c1">// 인증서버로 요청  </span>
      <span class="nx">signIn</span><span class="p">(</span><span class="dl">"</span><span class="s2">credentials</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>  
        <span class="na">message</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">),</span>  
        <span class="na">redirect</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>  
        <span class="na">signature</span><span class="p">:</span> <span class="nx">serializedSignature</span><span class="p">,</span>  
      <span class="p">});</span>  
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>  
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>  
    <span class="p">}</span>  
  <span class="p">};</span>  
            
  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>  
    <span class="k">if</span> <span class="p">(</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">connected</span> <span class="o">&amp;&amp;</span> <span class="nx">status</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">unauthenticated</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>  
      <span class="nx">handleSignIn</span><span class="p">();</span>  
    <span class="p">}</span>  
  <span class="p">},</span> <span class="p">[</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">connected</span><span class="p">]);</span>  
            
  <span class="k">return</span> <span class="p">(</span>  
    <span class="o">&lt;</span><span class="nx">header</span><span class="o">&gt;</span>  
      <span class="o">&lt;</span><span class="nx">noscript</span><span class="o">&gt;</span>  
        <span class="o">&lt;</span><span class="nx">style</span><span class="o">&gt;</span><span class="p">{</span><span class="s2">`.nojs-show { opacity: 1; top: 0; }`</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/style&gt; </span><span class="err"> 
</span>      <span class="o">&lt;</span><span class="sr">/noscript&gt; </span><span class="err"> 
</span>      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">signedInStatus</span><span class="p">}</span><span class="o">&gt;</span>  
        <span class="o">&lt;</span><span class="nx">p</span>  
          <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="s2">`nojs-show </span><span class="p">${</span>  
            <span class="o">!</span><span class="nx">session</span> <span class="o">&amp;&amp;</span> <span class="nx">loading</span> <span class="p">?</span> <span class="nx">styles</span><span class="p">.</span><span class="nx">loading</span> <span class="p">:</span> <span class="nx">styles</span><span class="p">.</span><span class="nx">loaded</span>  
          <span class="p">}</span><span class="s2">`</span><span class="p">}</span>  
        <span class="o">&gt;</span>  
          <span class="p">{</span><span class="o">!</span><span class="nx">session</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>  
            <span class="o">&lt;&gt;</span>  
              <span class="o">&lt;</span><span class="nx">span</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">notSignedInText</span><span class="p">}</span><span class="o">&gt;</span>  
                <span class="nx">You</span> <span class="nx">are</span> <span class="nx">not</span> <span class="nx">signed</span> <span class="k">in</span>  
              <span class="o">&lt;</span><span class="sr">/span&gt; </span><span class="err"> 
</span>              <span class="o">&lt;</span><span class="nx">span</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonPrimary</span><span class="p">}</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSignIn</span><span class="p">}</span><span class="o">&gt;</span>  
                <span class="nx">Sign</span> <span class="k">in</span>  
              <span class="o">&lt;</span><span class="sr">/span&gt; </span><span class="err"> 
</span>            <span class="o">&lt;</span><span class="sr">/&gt; </span><span class="err"> 
</span>          <span class="p">)}</span>  
          <span class="p">{</span><span class="nx">session</span><span class="p">?.</span><span class="nx">user</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>  
            <span class="o">&lt;&gt;</span>  
              <span class="p">{</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">image</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>  
                <span class="o">&lt;</span><span class="nx">span</span>  
                  <span class="nx">style</span><span class="o">=</span><span class="p">{{</span> <span class="na">backgroundImage</span><span class="p">:</span> <span class="s2">`url('</span><span class="p">${</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">image</span><span class="p">}</span><span class="s2">')`</span><span class="p">}}</span>  
                  <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">avatar</span><span class="p">}</span>  
                <span class="sr">/&gt; </span><span class="err"> 
</span>              <span class="p">)}</span>  
              <span class="o">&lt;</span><span class="nx">span</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">signedInText</span><span class="p">}</span><span class="o">&gt;</span>  
                <span class="o">&lt;</span><span class="nx">small</span><span class="o">&gt;</span><span class="nx">Signed</span> <span class="k">in</span> <span class="k">as</span><span class="o">&lt;</span><span class="sr">/small&gt; </span><span class="err"> 
</span>                <span class="o">&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>  
                <span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">??</span> <span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/strong&gt; </span><span class="err"> 
</span>              <span class="o">&lt;</span><span class="sr">/span&gt; </span><span class="err"> 
</span>              <span class="o">&lt;</span><span class="nx">a</span>  
                <span class="nx">href</span><span class="o">=</span><span class="p">{</span><span class="s2">`/api/auth/signout`</span><span class="p">}</span>  
                <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span>  
                <span class="nx">onClick</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>  
                  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>  
                  <span class="nx">signOut</span><span class="p">();</span>  
                <span class="p">}}</span>  
              <span class="o">&gt;</span>  
                <span class="nx">Sign</span> <span class="nx">out</span>  
              <span class="o">&lt;</span><span class="sr">/a&gt; </span><span class="err"> 
</span>            <span class="o">&lt;</span><span class="sr">/&gt; </span><span class="err"> 
</span>          <span class="p">)}</span>  
        <span class="o">&lt;</span><span class="sr">/p&gt; </span><span class="err"> 
</span>      <span class="o">&lt;</span><span class="sr">/div&gt; </span><span class="err"> 
</span>      <span class="o">&lt;</span><span class="nx">nav</span><span class="o">&gt;</span>  
        <span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">navItems</span><span class="p">}</span><span class="o">&gt;</span>  
          <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">navItem</span><span class="p">}</span><span class="o">&gt;</span>  
            <span class="o">&lt;</span><span class="nx">Link</span> <span class="nx">legacyBehavior</span> <span class="nx">href</span><span class="o">=</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="o">&gt;</span>  
              <span class="o">&lt;</span><span class="nx">a</span><span class="o">&gt;</span><span class="nx">Home</span><span class="o">&lt;</span><span class="sr">/a&gt; </span><span class="err"> 
</span>            <span class="o">&lt;</span><span class="sr">/Link&gt; </span><span class="err"> 
</span>          <span class="o">&lt;</span><span class="sr">/li&gt; </span><span class="err"> 
</span>          <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">navItem</span><span class="p">}</span><span class="o">&gt;</span>  
            <span class="o">&lt;</span><span class="nx">Link</span> <span class="nx">legacyBehavior</span> <span class="nx">href</span><span class="o">=</span><span class="dl">"</span><span class="s2">/api/examples/protected</span><span class="dl">"</span><span class="o">&gt;</span>  
              <span class="o">&lt;</span><span class="nx">a</span><span class="o">&gt;</span><span class="nx">Protected</span> <span class="nx">API</span> <span class="nx">Route</span><span class="o">&lt;</span><span class="sr">/a&gt; </span><span class="err"> 
</span>            <span class="o">&lt;</span><span class="sr">/Link&gt; </span><span class="err"> 
</span>          <span class="o">&lt;</span><span class="sr">/li&gt; </span><span class="err"> 
</span>          <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">navItem</span><span class="p">}</span><span class="o">&gt;</span>  
            <span class="o">&lt;</span><span class="nx">Link</span> <span class="nx">legacyBehavior</span> <span class="nx">href</span><span class="o">=</span><span class="dl">"</span><span class="s2">/me</span><span class="dl">"</span><span class="o">&gt;</span>  
              <span class="o">&lt;</span><span class="nx">a</span><span class="o">&gt;</span><span class="nx">Me</span><span class="o">&lt;</span><span class="sr">/a&gt; </span><span class="err"> 
</span>            <span class="o">&lt;</span><span class="sr">/Link&gt; </span><span class="err"> 
</span>          <span class="o">&lt;</span><span class="sr">/li&gt; </span><span class="err"> 
</span>        <span class="o">&lt;</span><span class="sr">/ul&gt; </span><span class="err"> 
</span>      <span class="o">&lt;</span><span class="sr">/nav&gt; </span><span class="err"> 
</span>    <span class="o">&lt;</span><span class="sr">/header&gt; </span><span class="err"> 
</span>  <span class="p">);</span>  
<span class="p">}</span>  
            
</pre></table></code></div></div></ul><h2 id="백엔드">백엔드</h2><ul><li>설명<ul><li>프론트엔드에서 인증요청을 받아서<br /> 인증여부를 처리하는 부분이다.<li>유저가 전달한 (메세지, 서명, 공개키)를 이용하여<br /> 인증 요청자 지갑 소유 여부를 확인한다.<li>인증에 성공하면 jwt를 세션에 담아 응답을 보낸다.<br /> <a href="https://next-auth.js.org/configuration/options#options" target="_blank">세션 생성 함수 NextAuth(req, res, configuration) 문서</a></ul><li>코드<div class="language-typescript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
</pre><td class="rouge-code"><pre>            
<span class="cm">/* Reference by: https://www.quicknode.com/guides/solana-development/dapps/how-to-authenticate-users-with-a-solana-wallet#implement-backend-api */</span>  
            
<span class="k">import</span> <span class="p">{</span> <span class="nx">NextApiRequest</span><span class="p">,</span> <span class="nx">NextApiResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">next</span><span class="dl">"</span><span class="p">;</span>  
<span class="k">import</span> <span class="nx">NextAuth</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">next-auth</span><span class="dl">"</span><span class="p">;</span>  
<span class="k">import</span> <span class="nx">CredentialsProvider</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">next-auth/providers/credentials</span><span class="dl">"</span><span class="p">;</span>  
<span class="k">import</span> <span class="p">{</span> <span class="nx">getCsrfToken</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">next-auth/react</span><span class="dl">"</span><span class="p">;</span>  
<span class="k">import</span> <span class="p">{</span> <span class="nx">SigninMessage</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../../utils/SigninMessage</span><span class="dl">"</span><span class="p">;</span>  
            
<span class="k">export</span> <span class="k">default</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">auth</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">NextApiRequest</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">NextApiResponse</span><span class="p">)</span> <span class="p">{</span>  
  <span class="kd">const</span> <span class="nx">providers</span> <span class="o">=</span> <span class="p">[</span>  
    <span class="nx">CredentialsProvider</span><span class="p">({</span>  
      <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Solana</span><span class="dl">"</span><span class="p">,</span>  
      <span class="na">credentials</span><span class="p">:</span> <span class="p">{</span>  
        <span class="na">message</span><span class="p">:</span> <span class="p">{</span>  
          <span class="na">label</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Message</span><span class="dl">"</span><span class="p">,</span>  
          <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">,</span>  
        <span class="p">},</span>  
        <span class="na">signature</span><span class="p">:</span> <span class="p">{</span>  
          <span class="na">label</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Signature</span><span class="dl">"</span><span class="p">,</span>  
          <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">,</span>  
        <span class="p">},</span>  
      <span class="p">},</span>  
      <span class="k">async</span> <span class="nx">authorize</span><span class="p">(</span><span class="nx">credentials</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>  
        <span class="k">try</span> <span class="p">{</span>  
          <span class="kd">const</span> <span class="nx">signinMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SigninMessage</span><span class="p">(</span>  
            <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">credentials</span><span class="p">?.</span><span class="nx">message</span> <span class="o">||</span> <span class="dl">"</span><span class="s2">{}</span><span class="dl">"</span><span class="p">)</span>  
          <span class="p">);</span>  
            
          <span class="c1">// domain 유효성 확인  </span>
          <span class="kd">const</span> <span class="nx">nextAuthUrl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXTAUTH_URL</span><span class="p">);</span>  
          <span class="k">if</span> <span class="p">(</span><span class="nx">signinMessage</span><span class="p">.</span><span class="nx">domain</span> <span class="o">!==</span> <span class="nx">nextAuthUrl</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> <span class="p">{</span>  
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>  
          <span class="p">}</span>  
            
          <span class="c1">// csrf 토큰 유효성 확인  </span>
          <span class="kd">const</span> <span class="nx">csrfToken</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getCsrfToken</span><span class="p">({</span> <span class="na">req</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span><span class="nx">req</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="kc">null</span> <span class="p">}</span> <span class="p">});</span>  
            
          <span class="k">if</span> <span class="p">(</span><span class="nx">signinMessage</span><span class="p">.</span><span class="nx">nonce</span> <span class="o">!==</span> <span class="nx">csrfToken</span><span class="p">)</span> <span class="p">{</span>  
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>  
          <span class="p">}</span>  
            
          <span class="c1">// 서명 유효성 확인  </span>
          <span class="kd">const</span> <span class="nx">validationResult</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">signinMessage</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span>  
            <span class="nx">credentials</span><span class="p">?.</span><span class="nx">signature</span> <span class="o">||</span> <span class="dl">""</span>  
          <span class="p">);</span>  
            
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">validationResult</span><span class="p">)</span>  
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Could not validate the signed message</span><span class="dl">"</span><span class="p">);</span>  
            
          <span class="k">return</span> <span class="p">{</span>  
            <span class="na">id</span><span class="p">:</span> <span class="nx">signinMessage</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">,</span>  
          <span class="p">};</span>  
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>  
          <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>  
        <span class="p">}</span>  
      <span class="p">},</span>  
    <span class="p">}),</span>  
  <span class="p">];</span>  
            
  <span class="kd">const</span> <span class="nx">isDefaultSigninPage</span> <span class="o">=</span>  
    <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">nextauth</span><span class="p">?.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">"</span><span class="s2">signin</span><span class="dl">"</span><span class="p">);</span>  
            
  <span class="c1">// Hides Sign-In with Solana from the default sign page  </span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isDefaultSigninPage</span><span class="p">)</span> <span class="p">{</span>  
    <span class="nx">providers</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>  
  <span class="p">}</span>  
            
  <span class="c1">// 세션 생성  </span>
  <span class="k">return</span> <span class="k">await</span> <span class="nx">NextAuth</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">{</span>  
    <span class="nx">providers</span><span class="p">,</span>  
    <span class="na">session</span><span class="p">:</span> <span class="p">{</span>  
      <span class="na">strategy</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jwt</span><span class="dl">"</span><span class="p">,</span>  
    <span class="p">},</span>  
    <span class="na">secret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXTAUTH_SECRET</span><span class="p">,</span>  
    <span class="na">callbacks</span><span class="p">:</span> <span class="p">{</span>  
      <span class="k">async</span> <span class="nx">session</span><span class="p">({</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">token</span> <span class="p">})</span> <span class="p">{</span>  
        <span class="c1">// @ts-ignore  </span>
        <span class="nx">session</span><span class="p">.</span><span class="nx">publicKey</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">sub</span><span class="p">;</span>  
        <span class="k">if</span> <span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>  
          <span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">sub</span><span class="p">;</span>  
          <span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">image</span> <span class="o">=</span> <span class="s2">`https://ui-avatars.com/api/?name=</span><span class="p">${</span><span class="nx">token</span><span class="p">.</span><span class="nx">sub</span><span class="p">}</span><span class="s2">&amp;background=random`</span><span class="p">;</span>  
        <span class="p">}</span>  
        <span class="k">return</span> <span class="nx">session</span><span class="p">;</span>  
      <span class="p">},</span>  
    <span class="p">},</span>  
  <span class="p">});</span>  
<span class="p">}</span>  
            
</pre></table></code></div></div></ul><h2 id="참고">참고</h2><ul><li><a href="https://www.quicknode.com/guides/solana-development/dapps/how-to-authenticate-users-with-a-solana-wallet#overview" target="_blank">How to Integrate Sign-in Authentication with a Solana Wallet</a><li><a href="https://github.com/dchest/tweetnacl-js/blob/master/README.md#naclsigndetachedverifymessage-signature-publickey" target="_blank">tweetnacl 공식문서</a><li><a href="https://next-auth.js.org/configuration/options#options" target="_blank">NextAuth.js 공식문서</a><li><a href="https://ko.wikipedia.org/wiki/%EC%A0%84%EC%9E%90%EC%84%9C%EB%AA%85" target="_blank">전자서명 위키백과</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/react/'>React</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/solana/" class="post-tag no-text-decoration" >solana</a> <a href="/tags/next/" class="post-tag no-text-decoration" >next</a> <a href="/tags/react/" class="post-tag no-text-decoration" >react</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=solana DApp 인증 구현 - 의사줌치&url=https://a3magic3pocket.github.io/posts/solana-wallet-signin/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=solana DApp 인증 구현 - 의사줌치&u=https://a3magic3pocket.github.io/posts/solana-wallet-signin/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=solana DApp 인증 구현 - 의사줌치&url=https://a3magic3pocket.github.io/posts/solana-wallet-signin/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/kafka-large-scale-event-processing-architecture-and-performance-comparison/">Kafka를 활용한 대용량 이벤트 처리 구조 설계와 성능 비교</a><li><a href="/posts/experimenting-with-blue-green-deployments/">블루 - 그린 배포 실험</a><li><a href="/posts/spring-kafka-latest-message-pub-sub-config/">Spring Kafka에서 최신 메시지만 소비하는 Pub/Sub 방식 설정</a><li><a href="/posts/solving-concurrency-problems-with-performance-in-mind/">동시성 문제 해결 방안 성능 실험</a><li><a href="/posts/exploring-authentication-options/">인증방식 고민</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/kafka/">kafka</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/elasticsearch/">elasticsearch</a> <a class="post-tag" href="/tags/elk/">elk</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/summary/">summary</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/kafka-streams/">kafka-streams</a> <a class="post-tag" href="/tags/nest/">nest</a> <a class="post-tag" href="/tags/react/">react</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/how-to-use-react-portal/"><div class="card-body"> <span class="timeago small" > Nov 20, 2023 <i class="unloaded">2023-11-20T17:38:29+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>juqery library element에 React component 연동하기(react portal)</h3><div class="text-muted small"><p> 설명 react로 개발하다보면 react를 지원하지 않는 library(비react library)를 사용해야할 경우가 생긴다. 비react library element에 react component를 연동해야할 일이 있다면 react portal을 사용하여 해결할 수 있다. react portal이란? 공식홈페이지 createPo...</p></div></div></a></div><div class="card"> <a href="/posts/next-reference-error-self-is-not-defined/"><div class="card-body"> <span class="timeago small" > Nov 20, 2023 <i class="unloaded">2023-11-20T18:15:03+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>next.js 빌드 시 ReferenceError: self is not defined 해결</h3><div class="text-muted small"><p> 설명 컴포넌트를 import 할 때 생길 수 있는 오류이다. import 대상 컴포넌트에 오직 클라이언트에서만 사용할 수 있는 기능이 포함된 경우, 사전 렌더링에 실패할때 이 오류가 발생한다. next/dynamic을 사용하여 ssr를 사용하지 않고 import를 하면 된다. 예시 import dynamic from "next/dyna...</p></div></div></a></div><div class="card"> <a href="/posts/where-you-save-auth-in-client/"><div class="card-body"> <span class="timeago small" > Aug 30, 2021 <i class="unloaded">2021-08-30T15:31:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>React 사용 시 JWT를 어디에 저장해야할까?</h3><div class="text-muted small"><p> 개요 예전에 React를 처음 사용할 때 backend를 jwt 인증방식으로 구현한 뒤 frontend에서는 이 jwt를 어디에 저장할지 고민했었다. 그때 4장. JWT 이해 및 적용를 보고 쿠키에 httpOnly 설정으로 저장하는 방법을 사용하기로 결정했다. 당시는 따라하는데 급급하여 무작정 똑같이 하였는데, 이번에 gonic-gin C...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/cerbot-route53/" class="btn btn-outline-primary" prompt="Older"><p>certbot, DNS 인증 시 자동 갱신하게 만들기(AWS Route 53)</p></a> <a href="/posts/decorators-legacy-error/" class="btn btn-outline-primary" prompt="Newer"><p>Support for the experimental syntax 'decorators-legacy' isn't currently enabled</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/a3magic3pocket">의사줌치</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/kafka/">kafka</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/elasticsearch/">elasticsearch</a> <a class="post-tag" href="/tags/elk/">elk</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/summary/">summary</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/kafka-streams/">kafka streams</a> <a class="post-tag" href="/tags/nest/">nest</a> <a class="post-tag" href="/tags/react/">react</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://a3magic3pocket.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
